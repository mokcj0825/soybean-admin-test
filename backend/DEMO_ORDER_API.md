# è®¢å•åˆ›å»ºAPIæ¼”ç¤ºæ–‡æ¡£

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„"åˆ›å»ºè®¢å•å¹¶å‘èµ·æ”¯ä»˜"åŠŸèƒ½æ¼”ç¤ºï¼Œé‡‡ç”¨ **CQRS + DDD + Event-Driven** æ¶æ„ã€‚

## æ¶æ„äº®ç‚¹

### 1. åˆ†å±‚æ¸…æ™°

```
ğŸ“ api/order/                      â† HTTP é€‚é…å±‚
  â”œâ”€â”€ dto/                         â† æ•°æ®ä¼ è¾“å¯¹è±¡
  â””â”€â”€ rest/order.controller.ts     â† è½»é‡çº§æ§åˆ¶å™¨ï¼ˆä»…5è¡Œæ ¸å¿ƒä»£ç ï¼‰

ğŸ“ lib/bounded-contexts/order/     â† ä¸šåŠ¡é€»è¾‘å±‚
  â”œâ”€â”€ commands/                    â† å‘½ä»¤å®šä¹‰
  â”œâ”€â”€ domain/                      â† é¢†åŸŸæ¨¡å‹ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰
  â”‚   â”œâ”€â”€ order.ts                 â† è®¢å•èšåˆæ ¹
  â”‚   â”œâ”€â”€ order-item.ts            â† è®¢å•æ˜ç»†
  â”‚   â”œâ”€â”€ money.value-object.ts    â† é‡‘é¢å€¼å¯¹è±¡
  â”‚   â””â”€â”€ events/                  â† é¢†åŸŸäº‹ä»¶
  â””â”€â”€ application/                 â† åº”ç”¨å±‚
      â”œâ”€â”€ command-handlers/        â† å‘½ä»¤å¤„ç†å™¨ï¼ˆæ ¸å¿ƒä¸šåŠ¡ç¼–æ’ï¼‰
      â”œâ”€â”€ event-handlers/          â† äº‹ä»¶å¤„ç†å™¨ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
      â””â”€â”€ service/                 â† åº”ç”¨æœåŠ¡
```

### 2. å…³æ³¨ç‚¹åˆ†ç¦»

| ç»„ä»¶ | èŒè´£ | ä»£ç è¡Œæ•° |
|------|------|---------|
| **Controller** | æ¥æ”¶HTTPè¯·æ±‚ï¼Œè¿”å›å“åº” | ~30è¡Œ |
| **Command Handler** | ä¸šåŠ¡é€»è¾‘ç¼–æ’ | ~200è¡Œ |
| **Domain Model** | ä¸šåŠ¡è§„åˆ™éªŒè¯ | ~150è¡Œ |
| **Event Handlers** | å¼‚æ­¥ä»»åŠ¡å¤„ç† | ~100è¡Œ |
| **Services** | å…·ä½“æ“ä½œæ‰§è¡Œ | ~400è¡Œ |

### 3. ä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
  â†“
Controller (æ¥æ”¶è¯·æ±‚)
  â†“
åˆ›å»º Command
  â†“
CommandBus.execute()
  â†“
CreateOrderWithPaymentHandler (æ ¸å¿ƒç¼–æ’)
  â”œâ”€â†’ éªŒè¯ç”¨æˆ·
  â”œâ”€â†’ éªŒè¯åº“å­˜å¹¶é¢„ç•™
  â”œâ”€â†’ éªŒè¯ä¼˜æƒ åˆ¸å¹¶é”å®š
  â”œâ”€â†’ è®¡ç®—ä»·æ ¼
  â”œâ”€â†’ åˆ›å»ºè®¢å•é¢†åŸŸå¯¹è±¡
  â”œâ”€â†’ æŒä¹…åŒ–ï¼ˆäº‹åŠ¡ï¼‰
  â”œâ”€â†’ å‘èµ·æ”¯ä»˜
  â””â”€â†’ å‘å¸ƒé¢†åŸŸäº‹ä»¶
       â†“
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â†“         â†“        â†“        â†“
å‘é€é‚®ä»¶  å‘é€çŸ­ä¿¡  è®°å½•æ—¥å¿—  åº“å­˜é¢„è­¦
(å¼‚æ­¥)    (å¼‚æ­¥)   (å¼‚æ­¥)   (å¼‚æ­¥)
```

## æ ¸å¿ƒæ¦‚å¿µæ¼”ç¤º

### 1. å€¼å¯¹è±¡ (Value Object)

`Money` ç±»å°è£…äº†é‡‘é¢ç›¸å…³çš„ä¸šåŠ¡è§„åˆ™ï¼š

```typescript
// âŒ ä¸ä½¿ç”¨å€¼å¯¹è±¡
order.totalAmount = -100;  // æ²¡æœ‰éªŒè¯ï¼Œå¯èƒ½å‡ºç°è´Ÿæ•°

// âœ… ä½¿ç”¨å€¼å¯¹è±¡
const amount = Money.from(-100);  // æŠ›å‡ºå¼‚å¸¸ï¼š"é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°"
```

### 2. èšåˆæ ¹ (Aggregate Root)

`Order` ç±»æ˜¯è®¢å•çš„èšåˆæ ¹ï¼Œä¿è¯ä¸šåŠ¡è§„åˆ™ï¼š

```typescript
// ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨éªŒè¯
Order.create({
  totalAmount: Money.from(100),
  discountAmount: Money.from(150),  // æŠ˜æ‰£å¤§äºæ€»é¢
  ...
});
// æŠ›å‡ºå¼‚å¸¸ï¼š"æŠ˜æ‰£é‡‘é¢ä¸èƒ½å¤§äºå•†å“æ€»é¢"
```

### 3. é¢†åŸŸäº‹ä»¶ (Domain Events)

è®¢å•åˆ›å»ºåè‡ªåŠ¨å‘å¸ƒäº‹ä»¶ï¼Œè§¦å‘åç»­æ“ä½œï¼š

```typescript
// è®¢å•åˆ›å»ºæ—¶
order.apply(new OrderCreatedEvent(...));

// è‡ªåŠ¨è§¦å‘
â†’ OrderCreatedHandler: å‘é€é‚®ä»¶ã€çŸ­ä¿¡
â†’ StockWarningHandler: æ£€æŸ¥åº“å­˜é¢„è­¦
```

### 4. CQRS (å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»)

```typescript
// å†™æ“ä½œï¼šé€šè¿‡ Command
const command = new CreateOrderWithPaymentCommand(...);
await commandBus.execute(command);

// è¯»æ“ä½œï¼šé€šè¿‡ Queryï¼ˆæœªåœ¨æ­¤demoä¸­å®ç°ï¼‰
const query = new GetOrderByIdQuery(orderId);
await queryBus.execute(query);
```

## æµ‹è¯•æ–¹æ³•

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
pnpm start:dev
```

### 2. å‘é€æµ‹è¯•è¯·æ±‚

ä½¿ç”¨ `backend/.http/order-test.http` æ–‡ä»¶æµ‹è¯•ï¼Œæˆ–ä½¿ç”¨ curlï¼š

```bash
curl -X POST http://localhost:9528/v1/order/create-with-payment \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user_test_001",
    "items": [
      {
        "productId": "prod_001",
        "skuId": "sku_001",
        "quantity": 2
      }
    ],
    "shippingAddressId": "addr_456",
    "couponCode": "SUMMER2024",
    "paymentMethod": "wechat_pay",
    "remark": "è¯·åœ¨ä¸‹åˆé€è¾¾"
  }'
```

### 3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º

ä½ ä¼šçœ‹åˆ°è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å„é˜¶æ®µçš„æ‰§è¡Œè¿‡ç¨‹
- ğŸ’¾ æ¨¡æ‹Ÿçš„ SQL è¯­å¥
- ğŸ“§ å¼‚æ­¥ä»»åŠ¡çš„è§¦å‘
- ğŸ’³ ç¬¬ä¸‰æ–¹APIè°ƒç”¨

## æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        å¼€å§‹å¤„ç†è®¢å•åˆ›å»ºå‘½ä»¤ (Command Handler)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€é˜¶æ®µ1ã€‘éªŒè¯ç”¨æˆ·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ [éªŒè¯ç”¨æˆ·] ç”¨æˆ·ID: user_test_001
   SQL: SELECT * FROM sys_user WHERE id = 'user_test_001'
   âœ… ç”¨æˆ·éªŒè¯é€šè¿‡: test_user (VIP)

ã€é˜¶æ®µ2ã€‘éªŒè¯åº“å­˜å¹¶é¢„ç•™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ [StockValidator] å¼€å§‹éªŒè¯åº“å­˜...
   å•†å“æ•°é‡: 1
   æ£€æŸ¥å•†å“ prod_001 (SKU: sku_001), éœ€è¦æ•°é‡: 2
   âœ… åº“å­˜å……è¶³ï¼Œå½“å‰åº“å­˜: 100
   ğŸ”’ é¢„ç•™åº“å­˜: UPDATE product_sku SET reserved_stock = ...

ã€é˜¶æ®µ3ã€‘éªŒè¯ä¼˜æƒ åˆ¸å¹¶é”å®š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ« [CouponValidator] éªŒè¯ä¼˜æƒ åˆ¸: SUMMER2024
   SQL: SELECT * FROM coupon WHERE code = 'SUMMER2024'
   âœ… ä¼˜æƒ åˆ¸æœ‰æ•ˆï¼Œæœªè¢«ä½¿ç”¨
   ğŸ”’ é”å®šä¼˜æƒ åˆ¸

ã€é˜¶æ®µ4ã€‘è®¡ç®—è®¢å•é‡‘é¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° [PriceCalculator] å¼€å§‹è®¡ç®—è®¢å•é‡‘é¢...
   å•†å“ å•†å“1: 99 Ã— 2 = 198
   ğŸ“Š å•†å“æ€»é¢: Â¥198.00
   ğŸ–ï¸  ä¼šå‘˜æŠ˜æ‰£ (VIP 5%): -Â¥9.90
   ğŸ« ä¼˜æƒ åˆ¸æŠ˜æ‰£ (SUMMER2024): -Â¥50.00
   ğŸšš è¿è´¹: Â¥0.00

   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   å•†å“æ€»é¢:   Â¥198.00
   ä¼˜æƒ é‡‘é¢:  -Â¥59.90
   è¿è´¹:      +Â¥0.00
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   åº”ä»˜é‡‘é¢:   Â¥138.10

ã€é˜¶æ®µ5ã€‘åˆ›å»ºè®¢å•é¢†åŸŸå¯¹è±¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   åˆ›å»ºäº† 1 ä¸ªè®¢å•æ˜ç»†
ğŸ‰ [Order Domain] è®¢å•èšåˆæ ¹å·²åˆ›å»º: ORD1234567890001

ã€é˜¶æ®µ6ã€‘æŒä¹…åŒ–è®¢å•ï¼ˆäº‹åŠ¡ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’¾ [äº‹åŠ¡] å¼€å§‹æ•°æ®åº“äº‹åŠ¡...
   BEGIN TRANSACTION;
   1ï¸âƒ£  æ’å…¥è®¢å•ä¸»è¡¨...
   2ï¸âƒ£  æ’å…¥è®¢å•æ˜ç»†...
   3ï¸âƒ£  æ‰£å‡åº“å­˜...
   4ï¸âƒ£  æ ‡è®°ä¼˜æƒ åˆ¸ä¸ºå·²ä½¿ç”¨...
   5ï¸âƒ£  è®°å½•æ“ä½œæ—¥å¿—...
   COMMIT;
   âœ… äº‹åŠ¡æäº¤æˆåŠŸ

ã€é˜¶æ®µ7ã€‘å‘èµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’³ [PaymentGateway] å‘èµ·æ”¯ä»˜...
   ğŸ“± è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API...
   POST https://api.mch.weixin.qq.com/v3/pay/transactions/native
   âœ… æ”¯ä»˜å‘èµ·æˆåŠŸ

ã€é˜¶æ®µ8ã€‘å‘å¸ƒé¢†åŸŸäº‹ä»¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“¢ å‡†å¤‡å‘å¸ƒäº‹ä»¶...
   âœ… äº‹ä»¶å·²å‘å¸ƒï¼ŒEvent Handlers å°†å¼‚æ­¥å¤„ç†

ğŸ¯ [Event Handler] OrderCreatedHandler è¢«è§¦å‘
   ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥...
   ğŸ“± å‘é€çŸ­ä¿¡é€šçŸ¥...
   ğŸ“ è®°å½•æ“ä½œæ—¥å¿—...
   âš ï¸  æ£€æŸ¥åº“å­˜é¢„è­¦...

ğŸ¯ [Event Handler] PaymentInitiatedHandler è¢«è§¦å‘
   â° å¯åŠ¨æ”¯ä»˜ç›‘æ§ä»»åŠ¡...
   ğŸ¯ é€šçŸ¥æ¨èç³»ç»Ÿ...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ

### ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆè¿‡ç¨‹å¼ï¼‰

```typescript
@Post('/create-order')
async createOrder() {
  // æ‰€æœ‰é€»è¾‘éƒ½åœ¨ Controller ä¸­
  await validateUser();
  await validateStock();
  await createOrder();
  await sendEmail();
  await sendSms();
  // 100+ è¡Œä»£ç 
}
```

**é—®é¢˜ï¼š**
- Controller å¤ªé‡
- éš¾ä»¥æµ‹è¯•
- éš¾ä»¥å¤ç”¨
- ä¸šåŠ¡è§„åˆ™åˆ†æ•£

### ç°æœ‰æ–¹æ¡ˆï¼ˆCQRS + DDDï¼‰

```typescript
// Controllerï¼ˆ5è¡Œï¼‰
@Post('/create-order')
async createOrder(@Body() dto) {
  const command = new CreateOrderCommand(...);
  return await commandBus.execute(command);
}

// Handlerï¼ˆä¸šåŠ¡ç¼–æ’ï¼‰
class CreateOrderHandler {
  async execute(command) {
    // æ¸…æ™°çš„ä¸šåŠ¡æµç¨‹
  }
}

// Domainï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰
class Order {
  // å°è£…ä¸šåŠ¡è§„åˆ™
}

// EventHandlerï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
class OrderCreatedHandler {
  // å¤„ç†åç»­ä»»åŠ¡
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… èŒè´£æ¸…æ™°
- âœ… æ˜“äºæµ‹è¯•
- âœ… æ˜“äºæ‰©å±•
- âœ… ä¸šåŠ¡è§„åˆ™é›†ä¸­

## æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ–°åŠŸèƒ½ï¼šè®¢å•å–æ¶ˆ

åªéœ€æ·»åŠ ï¼š

1. æ–°çš„ Command: `CancelOrderCommand`
2. æ–°çš„ Handler: `CancelOrderHandler`
3. æ–°çš„ Event: `OrderCancelledEvent`

**ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ï¼**

### æ·»åŠ æ–°çš„é€šçŸ¥æ–¹å¼ï¼šå¾®ä¿¡æ¨é€

åªéœ€æ·»åŠ ï¼š

1. æ–°çš„ EventHandler: `WeChatNotificationHandler`

ç›‘å¬ç°æœ‰çš„ `OrderCreatedEvent` å³å¯ã€‚

## æ€»ç»“

è¿™ä¸ª demo å±•ç¤ºäº†ï¼š

1. **åˆ†å±‚æ¶æ„** - Controller / Handler / Domain / Service å„å¸å…¶èŒ
2. **é¢†åŸŸé©±åŠ¨** - é€šè¿‡ Domain Model å°è£…ä¸šåŠ¡è§„åˆ™
3. **äº‹ä»¶é©±åŠ¨** - é€šè¿‡ Event è§£è€¦ä¸šåŠ¡é€»è¾‘
4. **CQRS** - å‘½ä»¤å’ŒæŸ¥è¯¢åˆ†ç¦»
5. **å¯æµ‹è¯•æ€§** - æ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
6. **å¯æ‰©å±•æ€§** - æ·»åŠ æ–°åŠŸèƒ½ä¸ä¿®æ”¹ç°æœ‰ä»£ç 

**è¿™å°±æ˜¯ä¼ä¸šçº§åç«¯æ¶æ„çš„æœ€ä½³å®è·µï¼**

