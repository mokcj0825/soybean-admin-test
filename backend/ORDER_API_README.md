# è®¢å•åˆ›å»ºAPI - å®Œæ•´å®ç°

## âœ¨ å·²å®ŒæˆåŠŸèƒ½

ä¸€ä¸ªå®Œæ•´çš„**"åˆ›å»ºè®¢å•å¹¶å‘èµ·æ”¯ä»˜"**APIï¼Œé‡‡ç”¨ **CQRS + DDD + Event-Driven** æ¶æ„ã€‚

### ğŸ“ åˆ›å»ºçš„æ–‡ä»¶ï¼ˆå…± 20+ ä¸ªï¼‰

```
backend/
â”œâ”€â”€ apps/base-system/src/
â”‚   â”œâ”€â”€ api/order/                              # âœ… HTTP å±‚
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-order.dto.ts            # è¯·æ±‚éªŒè¯
â”‚   â”‚   â”‚   â””â”€â”€ order-response.dto.ts          # å“åº”æ ¼å¼
â”‚   â”‚   â””â”€â”€ rest/
â”‚   â”‚       â”œâ”€â”€ order.controller.ts            # è½»é‡æ§åˆ¶å™¨
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â””â”€â”€ lib/bounded-contexts/order/             # âœ… ä¸šåŠ¡å±‚
â”‚       â”œâ”€â”€ commands/
â”‚       â”‚   â””â”€â”€ create-order-with-payment.command.ts
â”‚       â”œâ”€â”€ domain/                             # é¢†åŸŸæ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ order.ts                       # â­ è®¢å•èšåˆæ ¹
â”‚       â”‚   â”œâ”€â”€ order-item.ts                  # è®¢å•æ˜ç»†
â”‚       â”‚   â”œâ”€â”€ money.value-object.ts          # â­ é‡‘é¢å€¼å¯¹è±¡
â”‚       â”‚   â””â”€â”€ events/
â”‚       â”‚       â”œâ”€â”€ order-created.event.ts
â”‚       â”‚       â””â”€â”€ payment-initiated.event.ts
â”‚       â”œâ”€â”€ application/
â”‚       â”‚   â”œâ”€â”€ command-handlers/
â”‚       â”‚   â”‚   â”œâ”€â”€ create-order-with-payment.handler.ts  # â­â­â­ æ ¸å¿ƒç¼–æ’
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ event-handlers/
â”‚       â”‚   â”‚   â”œâ”€â”€ order-created.handler.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ payment-initiated.handler.ts
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â””â”€â”€ service/
â”‚       â”‚       â”œâ”€â”€ stock-validator.service.ts
â”‚       â”‚       â”œâ”€â”€ coupon-validator.service.ts
â”‚       â”‚       â”œâ”€â”€ price-calculator.service.ts
â”‚       â”‚       â””â”€â”€ payment-gateway.service.ts
â”‚       â””â”€â”€ order.module.ts
â”‚
â”œâ”€â”€ .http/
â”‚   â””â”€â”€ order-test.http                         # âœ… æµ‹è¯•ç”¨ä¾‹
â”‚
â””â”€â”€ ğŸ“š æ–‡æ¡£
    â”œâ”€â”€ DEMO_ORDER_API.md                       # æ¶æ„è¯´æ˜
    â”œâ”€â”€ ORDER_API_GUIDE.md                      # è¯¦ç»†æµ‹è¯•æŒ‡å—
    â”œâ”€â”€ ARCHITECTURE_COMPARISON.md              # æ¶æ„å¯¹æ¯”
    â””â”€â”€ ORDER_API_README.md                     # æœ¬æ–‡ä»¶
```

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. å¯åŠ¨æœåŠ¡

```bash
cd backend
pnpm start:dev
```

### 2. å‘é€æµ‹è¯•è¯·æ±‚

**æ–¹å¼Aï¼šä½¿ç”¨ curl**

```bash
curl -X POST http://localhost:9528/v1/order/create-with-payment \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user_001",
    "items": [{"productId": "prod_001", "skuId": "sku_001", "quantity": 2}],
    "shippingAddressId": "addr_456",
    "couponCode": "SUMMER2024",
    "paymentMethod": "wechat_pay",
    "remark": "æµ‹è¯•è®¢å•"
  }'
```

**æ–¹å¼Bï¼šä½¿ç”¨ .http æ–‡ä»¶**

1. æ‰“å¼€ `backend/.http/order-test.http`
2. ç‚¹å‡» `Send Request`

**æ–¹å¼Cï¼šä½¿ç”¨ Swagger**

è®¿é—®ï¼šhttp://localhost:9528/api-docs

---

## ğŸ“Š è§‚å¯Ÿæ‰§è¡Œæµç¨‹

å‘é€è¯·æ±‚åï¼Œåç«¯æ§åˆ¶å°ä¼šæ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        å¼€å§‹å¤„ç†è®¢å•åˆ›å»ºå‘½ä»¤ (Command Handler)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€é˜¶æ®µ1ã€‘éªŒè¯ç”¨æˆ·
ã€é˜¶æ®µ2ã€‘éªŒè¯åº“å­˜å¹¶é¢„ç•™
ã€é˜¶æ®µ3ã€‘éªŒè¯ä¼˜æƒ åˆ¸å¹¶é”å®š
ã€é˜¶æ®µ4ã€‘è®¡ç®—è®¢å•é‡‘é¢
ã€é˜¶æ®µ5ã€‘åˆ›å»ºè®¢å•é¢†åŸŸå¯¹è±¡
ã€é˜¶æ®µ6ã€‘æŒä¹…åŒ–è®¢å•ï¼ˆäº‹åŠ¡ï¼‰
ã€é˜¶æ®µ7ã€‘å‘èµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜
ã€é˜¶æ®µ8ã€‘å‘å¸ƒé¢†åŸŸäº‹ä»¶

ğŸ¯ [Event Handler] OrderCreatedHandler è¢«è§¦å‘
   ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥...
   ğŸ“± å‘é€çŸ­ä¿¡é€šçŸ¥...
   ğŸ“ è®°å½•æ“ä½œæ—¥å¿—...

ğŸ¯ [Event Handler] PaymentInitiatedHandler è¢«è§¦å‘
   â° å¯åŠ¨æ”¯ä»˜ç›‘æ§ä»»åŠ¡...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ¯ æ ¸å¿ƒäº®ç‚¹

### 1. Controller åªæœ‰ 5 è¡Œæ ¸å¿ƒä»£ç 

```typescript
@Post('create-with-payment')
async createOrderWithPayment(@Body() dto: CreateOrderDto) {
  const command = new CreateOrderWithPaymentCommand(...);
  const result = await this.commandBus.execute(command);
  return ApiRes.success(result);
}
```

**å¯¹æ¯”ä½ çš„æ–¹æ¡ˆï¼š** Controller é€šå¸¸éœ€è¦ 100+ è¡Œä»£ç ã€‚

---

### 2. é¢†åŸŸæ¨¡å‹è‡ªåŠ¨éªŒè¯ä¸šåŠ¡è§„åˆ™

```typescript
// æ— æ•ˆçš„è®¢å•æ— æ³•åˆ›å»º
Order.create({
  totalAmount: Money.from(100),
  discountAmount: Money.from(150),  // æŠ˜æ‰£å¤§äºæ€»é¢
  finalAmount: Money.from(-50),     // è´Ÿæ•°
});
// æŠ›å‡ºå¼‚å¸¸ï¼š"æŠ˜æ‰£é‡‘é¢ä¸èƒ½å¤§äºå•†å“æ€»é¢"
```

**å¯¹æ¯”ä½ çš„æ–¹æ¡ˆï¼š** ä¸šåŠ¡è§„åˆ™åˆ†æ•£åœ¨å„å¤„ï¼Œå®¹æ˜“é—æ¼ã€‚

---

### 3. äº‹ä»¶é©±åŠ¨å¼‚æ­¥å¤„ç†

```typescript
// è®¢å•åˆ›å»ºåè‡ªåŠ¨è§¦å‘å¤šä¸ªå¼‚æ­¥ä»»åŠ¡
order.apply(new OrderCreatedEvent(...));

â†’ å‘é€é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
â†’ å‘é€çŸ­ä¿¡ï¼ˆå¼‚æ­¥ï¼‰
â†’ è®°å½•æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰
â†’ åº“å­˜é¢„è­¦ï¼ˆå¼‚æ­¥ï¼‰

// å³ä½¿é‚®ä»¶å‘é€å¤±è´¥ï¼Œä¹Ÿä¸å½±å“è®¢å•åˆ›å»º
```

**å¯¹æ¯”ä½ çš„æ–¹æ¡ˆï¼š** æ‰€æœ‰æ“ä½œä¸²è¡Œæ‰§è¡Œï¼Œé‚®ä»¶å¤±è´¥å¯¼è‡´è®¢å•å¤±è´¥ã€‚

---

### 4. æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§

```typescript
await transaction(() => {
  createOrder();      // 1
  createOrderItems(); // 2
  deductStock();      // 3
  useCoupon();        // 4
  createPayment();    // 5
  // å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
});
```

**å¯¹æ¯”ä½ çš„æ–¹æ¡ˆï¼š** æ‰‹åŠ¨å›æ»šï¼Œå®¹æ˜“å‡ºé”™ã€‚

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

### 1. [DEMO_ORDER_API.md](./DEMO_ORDER_API.md)
- æ¶æ„è®¾è®¡è¯´æ˜
- æ ¸å¿ƒæ¦‚å¿µè§£æ
- CQRSã€DDDã€Event-Driven ä»‹ç»

### 2. [ORDER_API_GUIDE.md](./ORDER_API_GUIDE.md)
- å®Œæ•´çš„æµ‹è¯•æŒ‡å—
- æ§åˆ¶å°æ—¥å¿—è¯¦ç»†è§£æ
- é”™è¯¯åœºæ™¯æ¼”ç¤º
- æ ¸å¿ƒæ¦‚å¿µç†è§£

### 3. [ARCHITECTURE_COMPARISON.md](./ARCHITECTURE_COMPARISON.md)
- ä½ çš„æ–¹æ¡ˆ vs ç°æœ‰æ–¹æ¡ˆ
- ä»£ç å¯¹æ¯”
- ä¼˜åŠ£åŠ¿åˆ†æ
- é€‚ç”¨åœºæ™¯å»ºè®®

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### 1. åˆ†å±‚æ¶æ„

```
Controller    â†’ åªè´Ÿè´£ HTTP é€‚é…
   â†“
Handler       â†’ ä¸šåŠ¡é€»è¾‘ç¼–æ’
   â†“
Domain        â†’ ä¸šåŠ¡è§„åˆ™éªŒè¯
   â†“
Repository    â†’ æ•°æ®æŒä¹…åŒ–
```

**æ¯å±‚èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤ã€‚**

---

### 2. CQRSï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰

```typescript
// å‘½ä»¤ï¼ˆå†™æ“ä½œï¼‰
const command = new CreateOrderCommand(...);
await commandBus.execute(command);

// æŸ¥è¯¢ï¼ˆè¯»æ“ä½œï¼‰
const query = new GetOrderByIdQuery(orderId);
await queryBus.execute(query);
```

**è¯»å†™åˆ†ç¦»ï¼Œç‹¬ç«‹ä¼˜åŒ–ã€‚**

---

### 3. DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰

```typescript
// é¢†åŸŸå¯¹è±¡å°è£…ä¸šåŠ¡è§„åˆ™
class Order extends AggregateRoot {
  // ä¸šåŠ¡è§„åˆ™1ï¼šè®¢å•å¿…é¡»æœ‰å•†å“
  // ä¸šåŠ¡è§„åˆ™2ï¼šé‡‘é¢ä¸èƒ½ä¸ºè´Ÿ
  // ä¸šåŠ¡è§„åˆ™3ï¼šæŠ˜æ‰£ä¸èƒ½å¤§äºæ€»é¢
  
  static create(props) {
    // è‡ªåŠ¨éªŒè¯æ‰€æœ‰è§„åˆ™
    return new Order(props);
  }
}
```

**ä¸šåŠ¡è§„åˆ™é›†ä¸­ç®¡ç†ï¼Œä¸ä¼šé—æ¼ã€‚**

---

### 4. Event-Drivenï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

```typescript
// å‘å¸ƒäº‹ä»¶
order.apply(new OrderCreatedEvent(...));
order.commit();  // è§¦å‘æ‰€æœ‰ç›‘å¬å™¨

// ç›‘å¬äº‹ä»¶
@EventsHandler(OrderCreatedEvent)
class EmailHandler {
  async handle(event) {
    // å‘é€é‚®ä»¶
  }
}
```

**è§£è€¦ä¸šåŠ¡é€»è¾‘ï¼Œæ˜“äºæ‰©å±•ã€‚**

---

## ğŸ”§ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ è®¢å•å–æ¶ˆåŠŸèƒ½

åªéœ€ 3 æ­¥ï¼š

**1. åˆ›å»º Command**
```typescript
// commands/cancel-order.command.ts
export class CancelOrderCommand {
  constructor(public readonly orderId: string) {}
}
```

**2. åˆ›å»º Handler**
```typescript
// command-handlers/cancel-order.handler.ts
@CommandHandler(CancelOrderCommand)
class CancelOrderHandler {
  async execute(command: CancelOrderCommand) {
    // 1. æŸ¥è¯¢è®¢å•
    // 2. é‡Šæ”¾åº“å­˜
    // 3. é€€è¿˜ä¼˜æƒ åˆ¸
    // 4. å–æ¶ˆæ”¯ä»˜
    // 5. å‘å¸ƒ OrderCancelledEvent
  }
}
```

**3. åˆ›å»º Controller**
```typescript
@Delete(':id')
async cancel(@Param('id') orderId: string) {
  const command = new CancelOrderCommand(orderId);
  return await this.commandBus.execute(command);
}
```

**ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç ï¼**

---

## ğŸ“Š æŠ€æœ¯æ ˆ

- **NestJS** - Node.js æ¡†æ¶
- **CQRS** - å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»
- **TypeScript** - ç±»å‹å®‰å…¨
- **Prisma** - ORMï¼ˆæœ¬ demo æœªå®é™…è¿æ¥æ•°æ®åº“ï¼‰
- **class-validator** - DTO éªŒè¯
- **Swagger** - API æ–‡æ¡£

---

## ğŸ¯ ä¸ä½ çš„æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | ä½ çš„æ–¹æ¡ˆ | ç°æœ‰æ–¹æ¡ˆï¼ˆæœ¬ demoï¼‰ |
|------|---------|-------------------|
| Controller ä»£ç è¡Œæ•° | 100+ | 30 |
| ä¸šåŠ¡é€»è¾‘ä½ç½® | Controller | Handler |
| ä¸šåŠ¡è§„åˆ™éªŒè¯ | åˆ†æ•£ | é›†ä¸­åœ¨ Domain |
| é”™è¯¯å›æ»š | æ‰‹åŠ¨ | è‡ªåŠ¨ï¼ˆäº‹åŠ¡ï¼‰ |
| å¼‚æ­¥ä»»åŠ¡ | ä¸²è¡Œ | å¹¶è¡Œï¼ˆäº‹ä»¶ï¼‰ |
| å¹¶å‘å®‰å…¨ | æ‰‹åŠ¨åŠ é” | æ•°æ®åº“åŸå­æ“ä½œ |
| å¯æµ‹è¯•æ€§ | å›°éš¾ | ç®€å• |
| å¯æ‰©å±•æ€§ | ä¿®æ”¹ç°æœ‰ä»£ç  | æ·»åŠ æ–°ä»£ç  |

---

## ğŸ’¡ æ ¸å¿ƒä»·å€¼

è¿™ä¸ª demo ä¸ä»…ä»…æ˜¯ä¸€ä¸ªè®¢å• APIï¼Œå®ƒå±•ç¤ºäº†ï¼š

1. âœ… **ä¼ä¸šçº§æ¶æ„æ¨¡å¼**
2. âœ… **æœ€ä½³å®è·µçš„ä»£ç ç»„ç»‡**
3. âœ… **æ¸…æ™°çš„èŒè´£åˆ’åˆ†**
4. âœ… **å¥å£®çš„é”™è¯¯å¤„ç†**
5. âœ… **è‰¯å¥½çš„æ‰©å±•æ€§**
6. âœ… **å®Œæ•´çš„å¯è§‚å¯Ÿæ€§**

**è¿™æ˜¯ä½ ä»"å†™ä»£ç "åˆ°"æ¶æ„è®¾è®¡"çš„é‡è¦ä¸€æ­¥ï¼** ğŸš€

---

## ğŸ™ æ€»ç»“

**ä½ çš„æ–¹æ¡ˆï¼ˆè¿‡ç¨‹å¼ï¼‰ï¼š**
- é€‚åˆå¿«é€Ÿå¼€å‘ã€å°å‹é¡¹ç›®
- å­¦ä¹ æˆæœ¬ä½
- ä½†é•¿æœŸç»´æŠ¤å›°éš¾

**ç°æœ‰æ–¹æ¡ˆï¼ˆCQRS+DDDï¼‰ï¼š**
- é€‚åˆå¤æ‚ä¸šåŠ¡ã€é•¿æœŸé¡¹ç›®
- å­¦ä¹ æˆæœ¬é«˜
- ä½†é•¿æœŸæ”¶ç›Šå·¨å¤§

**å»ºè®®ï¼š**
1. å°é¡¹ç›®ï¼ˆ<20 æ¥å£ï¼‰â†’ ç”¨ä½ çš„æ–¹æ¡ˆ
2. ä¸­å‹é¡¹ç›®ï¼ˆ20-100 æ¥å£ï¼‰â†’ æ··åˆä½¿ç”¨
3. å¤§å‹é¡¹ç›®ï¼ˆ100+ æ¥å£ï¼‰â†’ ç”¨ç°æœ‰æ–¹æ¡ˆ

**Remember:** æ¶æ„æ²¡æœ‰é“¶å¼¹ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æ–¹æ¡ˆï¼ ğŸ¯

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æµ‹è¯• API** - å‘é€è¯·æ±‚ï¼Œè§‚å¯Ÿæ—¥å¿—
2. **é˜…è¯»ä»£ç ** - ç†è§£æ¯ä¸ªæ–‡ä»¶çš„èŒè´£
3. **æŸ¥çœ‹æ–‡æ¡£** - æ·±å…¥å­¦ä¹ æ¶æ„æ¦‚å¿µ
4. **å°è¯•æ‰©å±•** - æ·»åŠ è®¢å•æŸ¥è¯¢ã€å–æ¶ˆç­‰åŠŸèƒ½

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼** ğŸ‰

