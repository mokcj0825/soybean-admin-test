# ğŸš€ è®¢å•API - 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

## ç¬¬1æ­¥ï¼šå¯åŠ¨æœåŠ¡ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
cd backend
pnpm start:dev
```

ç­‰å¾…çœ‹åˆ°ï¼š
```
âœ… Application is running on: http://0.0.0.0:9528
```

---

## ç¬¬2æ­¥ï¼šå‘é€æµ‹è¯•è¯·æ±‚ï¼ˆ30ç§’ï¼‰

**å¤åˆ¶å¹¶æ‰§è¡Œï¼š**

```bash
curl -X POST http://localhost:9528/v1/order/create-with-payment \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user_001",
    "items": [
      {
        "productId": "prod_001",
        "skuId": "sku_001",
        "quantity": 2
      }
    ],
    "shippingAddressId": "addr_456",
    "couponCode": "SUMMER2024",
    "paymentMethod": "wechat_pay",
    "remark": "æµ‹è¯•è®¢å•"
  }'
```

---

## ç¬¬3æ­¥ï¼šè§‚å¯Ÿæ§åˆ¶å°ï¼ˆ3åˆ†é’Ÿï¼‰

ä½ ä¼šçœ‹åˆ°å®Œæ•´çš„æ‰§è¡Œæµç¨‹ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        å¼€å§‹å¤„ç†è®¢å•åˆ›å»ºå‘½ä»¤ (Command Handler)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€é˜¶æ®µ1ã€‘éªŒè¯ç”¨æˆ·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤ [éªŒè¯ç”¨æˆ·] ç”¨æˆ·ID: user_001
   SQL: SELECT * FROM sys_user WHERE id = 'user_001'
   âœ… ç”¨æˆ·éªŒè¯é€šè¿‡: test_user (VIP)

ã€é˜¶æ®µ2ã€‘éªŒè¯åº“å­˜å¹¶é¢„ç•™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ [StockValidator] å¼€å§‹éªŒè¯åº“å­˜...
   æ£€æŸ¥å•†å“ prod_001 (SKU: sku_001), éœ€è¦æ•°é‡: 2
   âœ… åº“å­˜å……è¶³ï¼Œå½“å‰åº“å­˜: 100
   ğŸ”’ é¢„ç•™åº“å­˜: UPDATE product_sku SET reserved_stock = ...

ã€é˜¶æ®µ3ã€‘éªŒè¯ä¼˜æƒ åˆ¸å¹¶é”å®š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ« [CouponValidator] éªŒè¯ä¼˜æƒ åˆ¸: SUMMER2024
   âœ… ä¼˜æƒ åˆ¸æœ‰æ•ˆï¼Œæœªè¢«ä½¿ç”¨
   ğŸ”’ é”å®šä¼˜æƒ åˆ¸

ã€é˜¶æ®µ4ã€‘è®¡ç®—è®¢å•é‡‘é¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° [PriceCalculator] å¼€å§‹è®¡ç®—è®¢å•é‡‘é¢...
   å•†å“ å•†å“1: 99 Ã— 2 = 198
   ğŸ“Š å•†å“æ€»é¢: Â¥198.00
   ğŸ–ï¸  ä¼šå‘˜æŠ˜æ‰£ (VIP 5%): -Â¥9.90
   ğŸ« ä¼˜æƒ åˆ¸æŠ˜æ‰£ (SUMMER2024): -Â¥50.00
   ğŸšš è¿è´¹: Â¥0.00
   
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   å•†å“æ€»é¢:   Â¥198.00
   ä¼˜æƒ é‡‘é¢:  -Â¥59.90
   è¿è´¹:      +Â¥0.00
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   åº”ä»˜é‡‘é¢:   Â¥138.10

ã€é˜¶æ®µ5ã€‘åˆ›å»ºè®¢å•é¢†åŸŸå¯¹è±¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‰ [Order Domain] è®¢å•èšåˆæ ¹å·²åˆ›å»º: ORD1736940123001

ã€é˜¶æ®µ6ã€‘æŒä¹…åŒ–è®¢å•ï¼ˆäº‹åŠ¡ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’¾ [äº‹åŠ¡] å¼€å§‹æ•°æ®åº“äº‹åŠ¡...
   BEGIN TRANSACTION;
   1ï¸âƒ£  æ’å…¥è®¢å•ä¸»è¡¨...
   2ï¸âƒ£  æ’å…¥è®¢å•æ˜ç»†...
   3ï¸âƒ£  æ‰£å‡åº“å­˜...
   4ï¸âƒ£  æ ‡è®°ä¼˜æƒ åˆ¸ä¸ºå·²ä½¿ç”¨...
   5ï¸âƒ£  è®°å½•æ“ä½œæ—¥å¿—...
   COMMIT;
   âœ… äº‹åŠ¡æäº¤æˆåŠŸ

ã€é˜¶æ®µ7ã€‘å‘èµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’³ [PaymentGateway] å‘èµ·æ”¯ä»˜...
   ğŸ“± è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API...
   POST https://api.mch.weixin.qq.com/v3/pay/transactions/native
   âœ… æ”¯ä»˜å‘èµ·æˆåŠŸ
   æ”¯ä»˜ID: pay_wechat_1736940123456
   äºŒç»´ç URL: weixin://wxpay/bizpayurl?pr=mock...

ã€é˜¶æ®µ8ã€‘å‘å¸ƒé¢†åŸŸäº‹ä»¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“¢ å‡†å¤‡å‘å¸ƒäº‹ä»¶...
   âœ… äº‹ä»¶å·²å‘å¸ƒ

ğŸ¯ [Event Handler] OrderCreatedHandler è¢«è§¦å‘
   ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥...  âœ…
   ğŸ“± å‘é€çŸ­ä¿¡é€šçŸ¥...  âœ…
   ğŸ“ è®°å½•æ“ä½œæ—¥å¿—...  âœ…
   âš ï¸  æ£€æŸ¥åº“å­˜é¢„è­¦...  âœ…

ğŸ¯ [Event Handler] PaymentInitiatedHandler è¢«è§¦å‘
   â° å¯åŠ¨æ”¯ä»˜ç›‘æ§ä»»åŠ¡...  âœ…
   ğŸ¯ é€šçŸ¥æ¨èç³»ç»Ÿ...  âœ…

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ç¬¬4æ­¥ï¼šæŸ¥çœ‹å“åº”ï¼ˆ30ç§’ï¼‰

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderId": "01JQWXYZ123ABC",
    "orderNumber": "ORD1736940123001",
    "totalAmount": 198,
    "discountAmount": 59.9,
    "shippingFee": 0,
    "finalAmount": 138.1,
    "paymentInfo": {
      "paymentId": "pay_wechat_1736940123456",
      "qrCodeUrl": "weixin://wxpay/bizpayurl?pr=mockORD...",
      "expireTime": "2024-01-15T12:30:00.000Z"
    },
    "estimatedDelivery": "2024-01-17T10:00:00.000Z"
  }
}
```

---

## ğŸ¯ ä½ åˆšæ‰ä½“éªŒäº†ä»€ä¹ˆï¼Ÿ

### âœ… 8 ä¸ªå®Œæ•´çš„ä¸šåŠ¡é˜¶æ®µ
1. ç”¨æˆ·éªŒè¯
2. åº“å­˜éªŒè¯å¹¶é¢„ç•™
3. ä¼˜æƒ åˆ¸éªŒè¯å¹¶é”å®š
4. ä»·æ ¼è®¡ç®—ï¼ˆå•†å“+æŠ˜æ‰£+è¿è´¹ï¼‰
5. åˆ›å»ºè®¢å•é¢†åŸŸå¯¹è±¡
6. æ•°æ®åº“äº‹åŠ¡æäº¤
7. å‘èµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜
8. å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆè§¦å‘å¼‚æ­¥ä»»åŠ¡ï¼‰

### âœ… CQRS + DDD + Event-Driven æ¶æ„
- **Controller**ï¼šåªè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼ˆ5è¡Œä»£ç ï¼‰
- **Command Handler**ï¼šç¼–æ’ä¸šåŠ¡é€»è¾‘ï¼ˆ200è¡Œä»£ç ï¼‰
- **Domain Model**ï¼šå°è£…ä¸šåŠ¡è§„åˆ™ï¼ˆ150è¡Œä»£ç ï¼‰
- **Event Handlers**ï¼šå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼ˆ100è¡Œä»£ç ï¼‰

### âœ… å…³é”®ç‰¹æ€§
- ğŸ”’ **å¹¶å‘å®‰å…¨**ï¼šåº“å­˜é¢„ç•™æœºåˆ¶
- ğŸ”„ **è‡ªåŠ¨å›æ»š**ï¼šæ•°æ®åº“äº‹åŠ¡ä¿è¯
- ğŸ“¬ **å¼‚æ­¥å¤„ç†**ï¼šé‚®ä»¶/çŸ­ä¿¡ä¸é˜»å¡ä¸»æµç¨‹
- âœ… **ä¸šåŠ¡è§„åˆ™**ï¼šé¢†åŸŸå¯¹è±¡è‡ªåŠ¨éªŒè¯
- ğŸ“Š **å¯è§‚å¯Ÿæ€§**ï¼šè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—

---

## ğŸ“š æ·±å…¥å­¦ä¹ 

### 1. æ¶æ„è®¾è®¡
é˜…è¯» [DEMO_ORDER_API.md](./DEMO_ORDER_API.md)
- CQRS æ˜¯ä»€ä¹ˆï¼Ÿ
- DDD æ˜¯ä»€ä¹ˆï¼Ÿ
- Event-Driven æ˜¯ä»€ä¹ˆï¼Ÿ

### 2. å¯¹æ¯”åˆ†æ
é˜…è¯» [ARCHITECTURE_COMPARISON.md](./ARCHITECTURE_COMPARISON.md)
- ä½ çš„æ–¹æ¡ˆ vs ç°æœ‰æ–¹æ¡ˆ
- ä¼˜åŠ£åŠ¿å¯¹æ¯”
- é€‚ç”¨åœºæ™¯

### 3. è¯¦ç»†æŒ‡å—
é˜…è¯» [ORDER_API_GUIDE.md](./ORDER_API_GUIDE.md)
- æ—¥å¿—è¯¦ç»†è§£æ
- é”™è¯¯åœºæ™¯æ¼”ç¤º
- æ‰©å±•ç¤ºä¾‹

### 4. ä»£ç é˜…è¯»é¡ºåº

**ç¬¬1æ­¥ï¼šç†è§£æ•°æ®æµ**
```
1. api/order/rest/order.controller.ts         (æ¥æ”¶è¯·æ±‚)
2. commands/create-order-with-payment.command.ts  (å‘½ä»¤å®šä¹‰)
3. command-handlers/create-order-with-payment.handler.ts  (æ ¸å¿ƒé€»è¾‘)
```

**ç¬¬2æ­¥ï¼šç†è§£é¢†åŸŸæ¨¡å‹**
```
4. domain/money.value-object.ts    (é‡‘é¢å€¼å¯¹è±¡)
5. domain/order-item.ts            (è®¢å•æ˜ç»†)
6. domain/order.ts                 (è®¢å•èšåˆæ ¹)
```

**ç¬¬3æ­¥ï¼šç†è§£äº‹ä»¶é©±åŠ¨**
```
7. domain/events/order-created.event.ts
8. event-handlers/order-created.handler.ts
9. event-handlers/payment-initiated.handler.ts
```

---

## ğŸ“ å…³é”®ä»£ç ç‰‡æ®µ

### Controllerï¼ˆ5è¡Œæ ¸å¿ƒä»£ç ï¼‰

```typescript
@Post('create-with-payment')
async createOrderWithPayment(@Body() dto: CreateOrderDto) {
  const command = new CreateOrderWithPaymentCommand(...);
  const result = await this.commandBus.execute(command);
  return ApiRes.success(result);
}
```

**å¯¹æ¯”ï¼šä½ çš„æ–¹æ¡ˆéœ€è¦ 100+ è¡Œ**

---

### é¢†åŸŸæ¨¡å‹ï¼ˆè‡ªåŠ¨éªŒè¯ä¸šåŠ¡è§„åˆ™ï¼‰

```typescript
class Order extends AggregateRoot {
  static create(props) {
    const order = new Order();
    // ... èµ‹å€¼
    
    order.validate();  // â† è‡ªåŠ¨éªŒè¯æ‰€æœ‰ä¸šåŠ¡è§„åˆ™
    
    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    order.apply(new OrderCreatedEvent(...));
    
    return order;
  }
  
  private validate() {
    // è§„åˆ™1ï¼šè®¢å•å¿…é¡»æœ‰å•†å“
    if (!this.items || this.items.length === 0) {
      throw new Error('è®¢å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå•†å“');
    }
    
    // è§„åˆ™2ï¼šæœ€ç»ˆé‡‘é¢ä¸èƒ½ä¸ºè´Ÿ
    if (this.finalAmount.isLessThan(Money.zero())) {
      throw new Error('è®¢å•æœ€ç»ˆé‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
    }
    
    // è§„åˆ™3ï¼šæŠ˜æ‰£ä¸èƒ½å¤§äºæ€»é¢
    if (this.discountAmount.isGreaterThan(this.totalAmount)) {
      throw new Error('æŠ˜æ‰£é‡‘é¢ä¸èƒ½å¤§äºå•†å“æ€»é¢');
    }
  }
}
```

**å¯¹æ¯”ï¼šä½ çš„æ–¹æ¡ˆä¸šåŠ¡è§„åˆ™åˆ†æ•£åœ¨å„å¤„**

---

### äº‹ä»¶é©±åŠ¨ï¼ˆè§£è€¦å¼‚æ­¥ä»»åŠ¡ï¼‰

```typescript
// å‘å¸ƒäº‹ä»¶
order.apply(new OrderCreatedEvent(...));
order.commit();

// è‡ªåŠ¨è§¦å‘å¤šä¸ª Handlerï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
@EventsHandler(OrderCreatedEvent)
class OrderCreatedHandler {
  async handle(event) {
    await Promise.all([
      this.sendEmail(event),      // å¼‚æ­¥
      this.sendSMS(event),         // å¼‚æ­¥
      this.recordLog(event),       // å¼‚æ­¥
      this.checkStock(event),      // å¼‚æ­¥
    ]);
  }
}
```

**å¯¹æ¯”ï¼šä½ çš„æ–¹æ¡ˆæ‰€æœ‰æ“ä½œä¸²è¡Œï¼Œé‚®ä»¶å¤±è´¥å¯¼è‡´è®¢å•å¤±è´¥**

---

## ğŸ’¡ æ ¸å¿ƒä»·å€¼

**è¿™ä¸ª demo æ•™ä¼šä½ ï¼š**

1. âœ… å¦‚ä½•è®¾è®¡æ¸…æ™°çš„åˆ†å±‚æ¶æ„
2. âœ… å¦‚ä½•é€šè¿‡é¢†åŸŸæ¨¡å‹å°è£…ä¸šåŠ¡è§„åˆ™
3. âœ… å¦‚ä½•ä½¿ç”¨äº‹ä»¶è§£è€¦ä¸šåŠ¡é€»è¾‘
4. âœ… å¦‚ä½•å¤„ç†å¤æ‚çš„äº‹åŠ¡å’Œå›æ»š
5. âœ… å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨
6. âœ… å¦‚ä½•æå‡ä»£ç å¯æµ‹è¯•æ€§
7. âœ… å¦‚ä½•æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§

**ä»"å†™ä»£ç "åˆ°"æ¶æ„è®¾è®¡"çš„é‡è¦ä¸€æ­¥ï¼** ğŸš€

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **æµ‹è¯•å®Œæˆ** - ä½ å·²ç»ä½“éªŒäº†å®Œæ•´æµç¨‹
2. ğŸ“– **é˜…è¯»ä»£ç ** - æŒ‰ç…§ä¸Šé¢çš„é¡ºåºç†è§£æ¯ä¸ªæ–‡ä»¶
3. ğŸ“š **å­¦ä¹ æ–‡æ¡£** - æ·±å…¥ç†è§£æ¶æ„æ¦‚å¿µ
4. ğŸ”§ **å°è¯•æ‰©å±•** - æ·»åŠ è®¢å•æŸ¥è¯¢ã€å–æ¶ˆç­‰åŠŸèƒ½

---

## ğŸ“ å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹ä»¥ä¸‹æ–‡æ¡£ï¼š

- [ORDER_API_README.md](./ORDER_API_README.md) - æ€»è§ˆ
- [DEMO_ORDER_API.md](./DEMO_ORDER_API.md) - æ¶æ„è¯´æ˜
- [ORDER_API_GUIDE.md](./ORDER_API_GUIDE.md) - è¯¦ç»†æŒ‡å—
- [ARCHITECTURE_COMPARISON.md](./ARCHITECTURE_COMPARISON.md) - æ–¹æ¡ˆå¯¹æ¯”

**Happy Coding! ğŸ‰**

