# æ¶æ„æ–¹æ¡ˆå¯¹æ¯”ï¼šä½ çš„æ–¹æ¡ˆ vs ç°æœ‰è„šæ‰‹æ¶æ–¹æ¡ˆ

## ğŸ“Š ç›´è§‚å¯¹æ¯”

### ä½ çš„æ–¹æ¡ˆï¼ˆè¿‡ç¨‹å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Controller                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @Post('/create-and-pay')                         â”‚  â”‚
â”‚  â”‚  async createAndPay(dto) {                        â”‚  â”‚
â”‚  â”‚    try {                                          â”‚  â”‚
â”‚  â”‚      1. await userService.validate()        â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€ æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
â”‚  â”‚      2. await stockService.validate()       â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€ éƒ½åœ¨è¿™é‡Œ
â”‚  â”‚      3. await stockService.validateVoucher()â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€ 
â”‚  â”‚      4. await stockService.calculate()      â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€ Controller
â”‚  â”‚      5. await orderService.create()         â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€ å¤ªé‡äº†ï¼
â”‚  â”‚      6. await paymentService.getToken()     â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€
â”‚  â”‚      7. await notificationService.send()    â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€
â”‚  â”‚      8. await stockService.checkLeftOver()  â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€
â”‚  â”‚      return success()                            â”‚  â”‚
â”‚  â”‚    } catch(e) { throw e }                        â”‚  â”‚
â”‚  â”‚  }                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                  â”‚
           â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ userService  â”‚                  â”‚ stockService â”‚
    â”‚              â”‚                  â”‚              â”‚
    â”‚ - validate() â”‚                  â”‚ - validate() â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ - voucher()  â”‚
                                      â”‚ - calculate()â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜ï¼š**
- âŒ Controller æ‰¿æ‹…å¤ªå¤šèŒè´£ï¼ˆ100+ è¡Œï¼‰
- âŒ ä¸šåŠ¡é€»è¾‘ä¸ HTTP åè®®è€¦åˆ
- âŒ stockService èŒè´£æ··ä¹±ï¼ˆåº“å­˜ã€ä¼˜æƒ åˆ¸ã€è®¡ç®—éƒ½åœ¨ä¸€èµ·ï¼‰
- âŒ éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦ mock æ‰€æœ‰ serviceï¼‰
- âŒ é”™è¯¯å›æ»šå¤æ‚ï¼ˆæ‰‹åŠ¨è¿½è¸ªæ¯ä¸€æ­¥çŠ¶æ€ï¼‰

---

### ç°æœ‰è„šæ‰‹æ¶æ–¹æ¡ˆï¼ˆCQRS + DDDï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HTTP Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Controller (5è¡Œæ ¸å¿ƒä»£ç )                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  @Post('/create-and-pay')                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  async create(@Body() dto) {                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    const cmd = new CreateOrderCommand(dto);        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    return await commandBus.execute(cmd); â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€ åªå‘å‘½ä»¤
â”‚  â”‚  â”‚  }                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Application Layer                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CreateOrderHandler (ä¸šåŠ¡ç¼–æ’)                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  async execute(command) {                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    1. validate user                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    2. validate & reserve stock   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ StockValidator
â”‚  â”‚  â”‚    3. validate & lock coupon     â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ CouponValidator
â”‚  â”‚  â”‚    4. calculate price            â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ PriceCalculator
â”‚  â”‚  â”‚    5. create domain object       â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ Order.create()
â”‚  â”‚  â”‚    6. save with transaction      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ Repository
â”‚  â”‚  â”‚    7. initiate payment           â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ PaymentGateway
â”‚  â”‚  â”‚    8. publish events             â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€ EventBus
â”‚  â”‚  â”‚  }                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Domain Layer                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚    Order     â”‚   â”‚  OrderItem   â”‚   â”‚    Money     â”‚       â”‚
â”‚  â”‚ (èšåˆæ ¹)     â”‚   â”‚              â”‚   â”‚  (å€¼å¯¹è±¡)    â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ - validate() â”‚   â”‚ - validate() â”‚   â”‚ - validate() â”‚       â”‚
â”‚  â”‚ - create()   â”‚   â”‚ - getTotal() â”‚   â”‚ - add()      â”‚       â”‚
â”‚  â”‚ - publish()  â”‚   â”‚              â”‚   â”‚ - subtract() â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€ OrderCreatedEvent                                   â”‚
â”‚         â””â”€ PaymentInitiatedEvent                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼ (å¼‚æ­¥)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Event Handlers                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ OrderCreated â”‚  â”‚   Payment    â”‚  â”‚ StockWarning â”‚         â”‚
â”‚  â”‚   Handler    â”‚  â”‚   Initiated  â”‚  â”‚   Handler    â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ - sendEmail  â”‚  â”‚ - monitor    â”‚  â”‚ - checkStock â”‚         â”‚
â”‚  â”‚ - sendSMS    â”‚  â”‚ - updateRec  â”‚  â”‚ - notifyAdm  â”‚         â”‚
â”‚  â”‚ - log        â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ¯å±‚èŒè´£å•ä¸€
- âœ… ä¸šåŠ¡é€»è¾‘ä¸åè®®è§£è€¦
- âœ… é¢†åŸŸå¯¹è±¡å°è£…ä¸šåŠ¡è§„åˆ™
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œè§£è€¦å¼‚æ­¥ä»»åŠ¡
- âœ… æ˜“äºæµ‹è¯•å’Œæ‰©å±•

---

## ğŸ“ˆ ä»£ç è¡Œæ•°å¯¹æ¯”

| æ–‡ä»¶/æ¨¡å— | ä½ çš„æ–¹æ¡ˆ | ç°æœ‰æ–¹æ¡ˆ | è¯´æ˜ |
|----------|---------|---------|------|
| **Controller** | 100+ è¡Œ | 30 è¡Œ | ç°æœ‰æ–¹æ¡ˆçš„ Controller åªåšé€‚é… |
| **ä¸šåŠ¡é€»è¾‘** | åˆ†æ•£åœ¨å„ Service | é›†ä¸­åœ¨ Handler | ç°æœ‰æ–¹æ¡ˆæ›´æ¸…æ™° |
| **Domain Model** | æ—  | 150 è¡Œ | å°è£…ä¸šåŠ¡è§„åˆ™ |
| **Event Handler** | æ—  | 100 è¡Œ | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **æ€»ä»£ç é‡** | ç›¸ä¼¼ | ç›¸ä¼¼ | ä½†ç°æœ‰æ–¹æ¡ˆç»„ç»‡æ›´å¥½ |

---

## ğŸ¯ å…³é”®å·®å¼‚

### 1. èŒè´£åˆ†é…

#### ä½ çš„æ–¹æ¡ˆ
```typescript
// Controller åšæ‰€æœ‰äº‹æƒ…
Controller {
  - HTTP é€‚é…
  - ä¸šåŠ¡éªŒè¯
  - ä¸šåŠ¡ç¼–æ’
  - é”™è¯¯å¤„ç†
  - äº‹åŠ¡ç®¡ç†
}
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
// å„å¸å…¶èŒ
Controller {
  - HTTP é€‚é… only
}

Handler {
  - ä¸šåŠ¡ç¼–æ’ only
}

Domain {
  - ä¸šåŠ¡è§„åˆ™ only
}

EventHandler {
  - å¼‚æ­¥ä»»åŠ¡ only
}
```

---

### 2. é”™è¯¯å¤„ç†

#### ä½ çš„æ–¹æ¡ˆ
```typescript
try {
  await step1();
  await step2();
  await step3();  // å¦‚æœè¿™é‡Œå¤±è´¥...
  await step4();
} catch (error) {
  // éœ€è¦æ‰‹åŠ¨å›æ»š step1, step2, step3
  await rollbackStep1();
  await rollbackStep2();
  await rollbackStep3();
  // å®¹æ˜“é—æ¼ï¼
}
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
try {
  // éªŒè¯é˜¶æ®µï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰
  await validate();
  
  // äº‹åŠ¡é˜¶æ®µï¼ˆæ•°æ®åº“è‡ªåŠ¨å›æ»šï¼‰
  await transaction(() => {
    step1();
    step2();
    step3();
    // ä»»ä½•å¤±è´¥ï¼Œæ•°æ®åº“è‡ªåŠ¨å›æ»š
  });
  
} catch (error) {
  // åªéœ€é‡Šæ”¾é¢„ç•™èµ„æº
  await releaseReservation();
}
```

---

### 3. å¹¶å‘å¤„ç†

#### ä½ çš„æ–¹æ¡ˆ
```typescript
// æ£€æŸ¥åº“å­˜
const stock = await getStock(productId);  // è¯»å– stock = 10

// æ‰£å‡åº“å­˜ï¼ˆä¸¤ä¸ªç”¨æˆ·åŒæ—¶æ‰§è¡Œï¼‰
if (stock >= quantity) {
  await updateStock(productId, stock - quantity);
  // å¯èƒ½è¶…å–ï¼ç”¨æˆ·Aå’Œç”¨æˆ·Béƒ½è¯»åˆ° stock = 10
}

// éœ€è¦æ‰‹åŠ¨åŠ é”
const lock = await redis.lock(`stock:${productId}`);
try {
  // ä¸šåŠ¡é€»è¾‘
} finally {
  await lock.release();
}
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
// ä½¿ç”¨æ•°æ®åº“åŸå­æ“ä½œ
await prisma.$executeRaw`
  UPDATE product_sku
  SET stock = stock - ${quantity}
  WHERE id = ${skuId}
    AND stock >= ${quantity}  -- åŸå­æ€§æ£€æŸ¥
  RETURNING *
`;

// æ•°æ®åº“ä¿è¯åŸå­æ€§ï¼Œæ— éœ€æ‰‹åŠ¨åŠ é”
// æ€§èƒ½æ›´å¥½ï¼Œä»£ç æ›´ç®€æ´
```

---

### 4. å¯æµ‹è¯•æ€§

#### ä½ çš„æ–¹æ¡ˆ
```typescript
// æµ‹è¯• Controller éœ€è¦ mock æ‰€æœ‰ä¾èµ–
describe('Controller', () => {
  it('should create order', async () => {
    const userService = mock();
    const stockService = mock();
    const orderService = mock();
    const paymentService = mock();
    const notificationService = mock();
    
    // è®¾ç½®æ¯ä¸ª service çš„è¿”å›å€¼
    userService.validate.mockResolvedValue(true);
    stockService.validate.mockResolvedValue(true);
    // ... å¤ªå¤šäº†
    
    const controller = new Controller(
      userService,
      stockService,
      orderService,
      paymentService,
      notificationService
    );
    
    await controller.createAndPay(dto);
  });
});
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
// æµ‹è¯• Domain Modelï¼ˆçº¯ä¸šåŠ¡è§„åˆ™ï¼Œæ— éœ€ mockï¼‰
describe('Order Domain', () => {
  it('should not allow negative amount', () => {
    expect(() => {
      Order.create({
        finalAmount: Money.from(-100)
      });
    }).toThrow('é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
    
    // æ— éœ€ä»»ä½• mockï¼
  });
});

// æµ‹è¯• Handlerï¼ˆåª mock å¿…è¦çš„ä¾èµ–ï¼‰
describe('CreateOrderHandler', () => {
  it('should create order', async () => {
    const stockValidator = mock();
    stockValidator.validate.mockResolvedValue(products);
    
    const handler = new CreateOrderHandler(stockValidator);
    await handler.execute(command);
  });
});
```

---

## ğŸš€ æ‰©å±•æ€§å¯¹æ¯”

### åœºæ™¯ï¼šæ·»åŠ æ–°æ”¯ä»˜æ–¹å¼ï¼ˆPayPalï¼‰

#### ä½ çš„æ–¹æ¡ˆ
```typescript
// éœ€è¦ä¿®æ”¹ paymentService.ts
class PaymentService {
  async getPaymentToken(method) {
    if (method === 'wechat') {
      // ...
    } else if (method === 'alipay') {
      // ...
    } else if (method === 'paypal') {  // â† ä¿®æ”¹ç°æœ‰ä»£ç 
      // ... æ–°å¢é€»è¾‘
    }
  }
}

// è¿åå¼€é—­åŸåˆ™ï¼ˆå¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ï¼‰
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
// æ–°å¢ PayPalProviderï¼ˆä¸ä¿®æ”¹ç°æœ‰ä»£ç ï¼‰
class PayPalProvider implements IPaymentProvider {
  async initiatePayment(params) {
    // PayPal é€»è¾‘
  }
}

// æ³¨å†Œåˆ° Module
@Module({
  providers: [
    WeChatProvider,
    AlipayProvider,
    PayPalProvider,  // â† åªéœ€æ·»åŠ 
  ]
})
```

---

### åœºæ™¯ï¼šè®¢å•åˆ›å»ºåæ¨é€åˆ°æ•°æ®åˆ†æç³»ç»Ÿ

#### ä½ çš„æ–¹æ¡ˆ
```typescript
// éœ€è¦ä¿®æ”¹ Controller
@Post('/create-and-pay')
async createAndPay(dto) {
  // ... åŸæœ‰é€»è¾‘
  await orderService.create();
  await paymentService.getToken();
  await notificationService.send();
  
  // æ–°å¢ï¼šæ¨é€åˆ°æ•°æ®åˆ†æ
  await analyticsService.push(order);  // â† ä¿®æ”¹ç°æœ‰ä»£ç 
  
  return success();
}
```

#### ç°æœ‰æ–¹æ¡ˆ
```typescript
// æ–°å¢ Event Handlerï¼ˆä¸ä¿®æ”¹ç°æœ‰ä»£ç ï¼‰
@EventsHandler(OrderCreatedEvent)
class AnalyticsHandler implements IEventHandler {
  async handle(event: OrderCreatedEvent) {
    await this.analyticsService.push(event);
  }
}

// è‡ªåŠ¨ç›‘å¬äº‹ä»¶ï¼Œæ— éœ€ä¿®æ”¹ Controller æˆ– Handler
```

---

## ğŸ“Š æœ€ç»ˆè¯„åˆ†

| ç»´åº¦ | ä½ çš„æ–¹æ¡ˆ | ç°æœ‰æ–¹æ¡ˆ |
|------|---------|---------|
| **åˆæœŸå¼€å‘é€Ÿåº¦** | â­â­â­â­â­ | â­â­â­ |
| **ä»£ç ç»„ç»‡** | â­â­ | â­â­â­â­â­ |
| **å¯ç»´æŠ¤æ€§** | â­â­ | â­â­â­â­â­ |
| **å¯æµ‹è¯•æ€§** | â­â­ | â­â­â­â­â­ |
| **å¯æ‰©å±•æ€§** | â­â­ | â­â­â­â­â­ |
| **å¹¶å‘å®‰å…¨** | â­â­ | â­â­â­â­â­ |
| **é”™è¯¯æ¢å¤** | â­â­ | â­â­â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­â­ | â­â­ |
| **å›¢é˜Ÿåä½œ** | â­â­â­ | â­â­â­â­â­ |
| **é•¿æœŸæˆæœ¬** | â­â­ | â­â­â­â­â­ |

---

## ğŸ¯ ç»“è®º

### ä½ çš„æ–¹æ¡ˆé€‚åˆï¼š
- âœ… ä¸ªäººé¡¹ç›®
- âœ… å¿«é€ŸåŸå‹
- âœ… ç®€å• CRUD
- âœ… å›¢é˜Ÿæˆå‘˜éƒ½æ˜¯åˆçº§å¼€å‘è€…

### ç°æœ‰è„šæ‰‹æ¶æ–¹æ¡ˆé€‚åˆï¼š
- âœ… ä¼ä¸šçº§åº”ç”¨
- âœ… å¤æ‚ä¸šåŠ¡é€»è¾‘
- âœ… é•¿æœŸç»´æŠ¤é¡¹ç›®
- âœ… å¤§å›¢é˜Ÿåä½œ
- âœ… é«˜å¹¶å‘åœºæ™¯
- âœ… éœ€è¦ä¸¥æ ¼çš„æ•°æ®ä¸€è‡´æ€§

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

**ä½ çš„æ–¹æ¡ˆæœ¬è´¨ï¼š**
- è¿‡ç¨‹å¼ç¼–ç¨‹
- é¢å‘æ•°æ®åº“è¡¨
- å…³æ³¨"æ€ä¹ˆåš"

**ç°æœ‰æ–¹æ¡ˆæœ¬è´¨ï¼š**
- é¢†åŸŸé©±åŠ¨è®¾è®¡
- é¢å‘ä¸šåŠ¡é¢†åŸŸ
- å…³æ³¨"åšä»€ä¹ˆ"

**ä¸¾ä¾‹è¯´æ˜ï¼š**

```
éœ€æ±‚ï¼š"è®¢å•æ€»é¢ä¸èƒ½ä¸ºè´Ÿæ•°"

ä½ çš„æ–¹æ¡ˆï¼š
  åœ¨ Controller ä¸­æ£€æŸ¥
  if (totalAmount < 0) throw new Error();
  â†’ ä¸šåŠ¡è§„åˆ™åˆ†æ•£

ç°æœ‰æ–¹æ¡ˆï¼š
  åœ¨ Money å€¼å¯¹è±¡ä¸­æ£€æŸ¥
  Money.from(-100)  // è‡ªåŠ¨æŠ›å¼‚å¸¸
  â†’ ä¸šåŠ¡è§„åˆ™é›†ä¸­åœ¨é¢†åŸŸå¯¹è±¡
```

---

## ğŸš€ å»ºè®®

1. **å°é¡¹ç›®ï¼ˆ< 20 æ¥å£ï¼‰**
   - ç”¨ä½ çš„æ–¹æ¡ˆï¼Œå¿«é€Ÿå¼€å‘

2. **ä¸­å‹é¡¹ç›®ï¼ˆ20-100 æ¥å£ï¼‰**
   - æ··åˆä½¿ç”¨ï¼š
     - ç®€å• CRUD ç”¨ä½ çš„æ–¹æ¡ˆ
     - å¤æ‚ä¸šåŠ¡ç”¨ç°æœ‰æ–¹æ¡ˆ

3. **å¤§å‹é¡¹ç›®ï¼ˆ100+ æ¥å£ï¼‰**
   - å®Œå…¨ä½¿ç”¨ç°æœ‰æ–¹æ¡ˆ
   - åˆæœŸæ…¢ä¸€ç‚¹ï¼Œé•¿æœŸæ”¶ç›Šå·¨å¤§

4. **å­¦ä¹ è·¯å¾„**
   - å…ˆæŒæ¡ä½ çš„æ–¹æ¡ˆï¼ˆåŸºç¡€ï¼‰
   - ç†è§£ä¸ºä»€ä¹ˆéœ€è¦æ”¹è¿›
   - å­¦ä¹  DDDã€CQRS æ¦‚å¿µ
   - å®è·µç°æœ‰æ–¹æ¡ˆ

**Remember:** æ²¡æœ‰é“¶å¼¹ï¼Œé€‰æ‹©æœ€é€‚åˆé¡¹ç›®çš„æ–¹æ¡ˆï¼ ğŸ¯

